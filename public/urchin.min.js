/*!
 * Urchin Version 0.1
 * A light-weight 3D renderer for realtime rendering in browser applications with the use of Canvas 2D.
 *
 * Copyright Trevor Richard
 *
 * Released under the MIT license
 * http://urchin3d.org/license
 */
var URCHIN_PATH="/Urchin.js",Vector=function(){function Vector(x,y,z){void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),this.x=x,this.y=y,this.z=z}return Vector.prototype.copy=function(){return new Vector(this.x,this.y,this.z)},Vector.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},Vector.prototype.add=function(a){switch(typeof a){case"number":return this.x+=a,this.y+=a,this.z+=a,this;case"object":return this.x+=a.x,this.y+=a.y,this.z+=a.z,this;default:return void console.error("Expected number or Vector, got "+typeof a+".")}},Vector.prototype.addX=function(a){return this.x+=a,this},Vector.prototype.addY=function(a){return this.y+=a,this},Vector.prototype.addZ=function(a){return this.z+=a,this},Vector.prototype.sub=function(a){switch(typeof a){case"number":return this.x-=a,this.y-=a,this.z-=a,this;case"object":return this.x-=a.x,this.y-=a.y,this.z-=a.z,this;default:return void console.error("Expected number or Vector, got "+typeof a+".")}},Vector.prototype.subX=function(a){return this.x-=a,this},Vector.prototype.subY=function(a){return this.y-=a,this},Vector.prototype.subZ=function(a){return this.z-=a,this},Vector.prototype.div=function(a){switch(typeof a){case"number":return 0==a?(console.error("Can't divide by zero."),this):(this.x/=a,this.y/=a,this.z/=a,this);case"object":return 0==a.x||0==a.y||0==a.z?(console.error("Can't divide by zero."),this):(this.x/=a.x,this.y/=a.y,this.z/=a.z,this);default:return console.error("Expected number or Vector, got "+typeof a+"."),this}},Vector.prototype.divX=function(a){if(0!=a)return this.x/=a,this;console.error("Can't divide by zero.")},Vector.prototype.divY=function(a){if(0!=a)return this.y/=a,this;console.error("Can't divide by zero.")},Vector.prototype.divZ=function(a){if(0!=a)return this.z/=a,this;console.error("Can't divide by zero.")},Vector.prototype.normalize=function(){var mag=this.mag();return 0==mag?this:this.div(mag)},Vector.prototype.mult=function(a){switch(typeof a){case"number":return this.x*=a,this.y*=a,this.z*=a,this;case"object":return this.x*=a.x,this.y*=a.y,this.z*=a.z,this;default:return void console.error("Expected number or Vector, got "+typeof a+".")}},Vector.prototype.multX=function(a){return this.x*=a,this},Vector.prototype.multY=function(a){return this.y*=a,this},Vector.prototype.multZ=function(a){return this.z*=a,this},Vector.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},Vector.prototype.cross=function(v){var c=new Vector(this.y*v.z-this.z*v.y,-(this.x*v.z-this.z*v.x),this.x*v.y-this.y*v.x);return this.x=c.x,this.y=c.y,this.z=c.z,this},Vector.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z},Vector.prototype.qRotate=function(q){return this.quaternionRotate(q)},Vector.prototype.quaternionRotate=function(q){q=q.normalize();var p=new Quaternion(0,this.x,this.y,this.z),c=Quaternion.conjugate(q);return p=Quaternion.qMult(q,p).qMult(c),this.x=p.i,this.y=p.j,this.z=p.k,this},Vector.prototype.transform=function(M){var x=this.x*M[0][0]+this.y*M[0][1]+this.z*M[0][2]+(M[0][3]||0),y=this.x*M[1][0]+this.y*M[1][1]+this.z*M[1][2]+(M[1][3]||0),z=this.x*M[2][0]+this.y*M[2][1]+this.z*M[2][2]+(M[2][3]||0);return this.x=x,this.y=y,this.z=z,this},Vector.prototype.rotateAxis=function(axis,angle){return this.quaternionRotate(Quaternion.fromAxisRotation(axis,angle))},Vector.prototype.rotateX=function(xAngle){return this.rotateAxis(Vector.X_AXIS,xAngle)},Vector.prototype.rotateY=function(yAngle){return this.rotateAxis(Vector.Y_AXIS,yAngle)},Vector.prototype.rotateZ=function(zAngle){return this.rotateAxis(Vector.Z_AXIS,zAngle)},Vector.prototype.angleBetween=function(v){var denominator=this.mag()*v.mag();return 0==denominator?0:Math.acos(Num.constrain(this.dot(v)/denominator,-1,1))},Vector.prototype.equals=function(v){return this.x==v.x&&this.y==v.y&&this.z==v.z},Vector.prototype.closest=function(V){if(1==V.length)return V[0];for(var minIndex=0,min,i=0;i<V.length;i++){var dist=Vector.sub(V[i],this).mag();(!min||dist<min)&&(min=dist,minIndex=i)}return V[minIndex]},Vector.prototype.furthest=function(V){if(1==V.length)return V[0];for(var maxIndex=0,max,i=0;i<V.length;i++){var dist=Vector.sub(V[i],this).mag();(!max||dist>max)&&(max=dist,maxIndex=i)}return V[maxIndex]},Vector.copy=function(v){return new Vector(v.x,v.y,v.z)},Vector.mag=function(v){return v.mag()},Vector.normalize=function(v){return v.copy().normalize()},Vector.add=function(v,a){return v.copy().add(a)},Vector.addX=function(v,a){return v.copy().addX(a)},Vector.addY=function(v,a){return v.copy().addY(a)},Vector.addZ=function(v,a){return v.copy().addZ(a)},Vector.sub=function(v,a){return v.copy().sub(a)},Vector.subX=function(v,a){return v.copy().subX(a)},Vector.subY=function(v,a){return v.copy().subY(a)},Vector.subZ=function(v,a){return v.copy().subZ(a)},Vector.div=function(v,a){return v.copy().div(a)},Vector.divX=function(v,a){return v.copy().divX(a)},Vector.divY=function(v,a){return v.copy().divY(a)},Vector.divZ=function(v,a){return v.copy().divZ(a)},Vector.mult=function(v,a){return v.copy().mult(a)},Vector.multX=function(v,a){return v.copy().multX(a)},Vector.multY=function(v,a){return v.copy().multY(a)},Vector.multZ=function(v,a){return v.copy().multZ(a)},Vector.neg=function(v){return v.copy().neg()},Vector.cross=function(v0,v1){return v0.copy().cross(v1)},Vector.dot=function(v0,v1){return v0.dot(v1)},Vector.qRotate=function(v,q){return Vector.quaternionRotate(v,q)},Vector.quaternionRotate=function(v,q){return v.copy().quaternionRotate(q)},Vector.transform=function(v,M){return v.copy().transform(M)},Vector.rotateAxis=function(v,axis,angle){return v.copy().rotateAxis(axis,angle)},Vector.rotateX=function(v,xAngle){return v.copy().rotateX(xAngle)},Vector.rotateY=function(v,yAngle){return v.copy().rotateY(yAngle)},Vector.rotateZ=function(v,zAngle){return v.copy().rotateZ(zAngle)},Vector.angleBetween=function(v0,v1){return v0.angleBetween(v1)},Vector.equals=function(v0,v1){return v0.equals(v1)},Vector.closest=function(v,V){return v.closest(V)},Vector.furthest=function(v,V){return v.furthest(V)},Vector.axis=function(a){switch(a){case Vector.X_AXIS:return new Vector(1,0,0);case Vector.Y_AXIS:return new Vector(0,1,0);case Vector.Z_AXIS:return new Vector(0,0,1)}return console.error("Axis ["+a+"] is not a valid axis number."),new Vector},Vector.xAxis=function(){return Vector.axis(Vector.X_AXIS)},Vector.yAxis=function(){return Vector.axis(Vector.Y_AXIS)},Vector.zAxis=function(){return Vector.axis(Vector.Z_AXIS)},Vector.X_AXIS=0,Vector.Y_AXIS=1,Vector.Z_AXIS=2,Vector}(),List=function(){function List(){this.count=0}return List.prototype.addLast=function(data,priority){void 0===priority&&(priority=0),this.updatePriority(priority);var node={nxt:void 0,data:data,priority:priority};void 0===this.tail||void 0===this.head?(this.head=node,this.tail=node):(this.tail.nxt=node,this.tail=node),this.count++},List.prototype.addFirst=function(data,priority){void 0===priority&&(priority=0),this.updatePriority(priority);var node={nxt:void 0,data:data,priority:priority};void 0===this.tail||void 0===this.head?(this.head=node,this.tail=node):(node.nxt=this.head,this.head=node),this.count++},List.prototype.updatePriority=function(priority){this.maxPriority||this.minPriority?(priority<this.minPriority&&(this.minPriority=priority),priority>this.maxPriority&&(this.maxPriority=priority)):(this.maxPriority=priority,this.minPriority=priority)},List.prototype.addByPriority=function(data,priority){var node={nxt:void 0,data:data,priority:priority};if(void 0===this.head||void 0===this.tail)this.head=node,this.tail=node;else if(node.priority>this.head.priority)node.nxt=this.head,this.head=node;else{for(var current=this.head;void 0!==current.nxt;){if(node.priority>=current.nxt.priority){node.nxt=current.nxt,current.nxt=node;break}current=current.nxt}void 0===current.nxt&&(this.tail.nxt=node,this.tail=node)}this.count++},List.prototype.addListByPriority=function(list){for(var current=list.head;current;)this.addByPriority(current.data,current.priority),current=current.nxt},List.prototype.linkLast=function(list){void 0!==list.tail&&(void 0!==this.tail?(this.tail.nxt=list.head,this.tail=list.tail,this.count+=list.count):(this.head=list.head,this.tail=list.tail,this.count=list.count),list.maxPriority>this.maxPriority&&(this.maxPriority=list.maxPriority),list.minPriority>this.minPriority&&(this.minPriority=list.minPriority))},List.prototype.linkFirst=function(list){void 0!==list.tail&&(void 0!==this.head?(list.tail.nxt=this.head,this.head=list.head,this.count+=list.count):(this.head=list.head,this.tail=list.tail,this.count=list.count),list.maxPriority>this.maxPriority&&(this.maxPriority=list.maxPriority),list.minPriority>this.minPriority&&(this.minPriority=list.minPriority))},List.prototype.copy=function(){for(var copy=new List,current=this.head;current;){var data=void 0!==current.data.copy?current.data.copy():current.data;copy.addLast(data,current.priority),current=current.nxt}return copy},List}(),Num=function(){function Num(){}return Num.getSign=function(a){return 0==a?1:a/Math.abs(a)},Num.constrain=function(val,low,high){return val<low?low:val>high?high:val},Num.byteToFloat=function(b3,b2,b1,b0){var data=[b0,b1,b2,b3],buf=new ArrayBuffer(4),view=new DataView(buf);return data.forEach((function(b,idx){view.setUint8(idx,b)})),view.getFloat32(0)},Num.avg=function(a){for(var total=0,i=0;i<a.length;i++)total+=a[i];return total/a.length},Num.rad=function(deg){return deg*Math.PI/180},Num.deg=function(rad){return 180*rad/Math.PI},Num}(),Color=function(){function Color(rhng,gsa,bl,a){if(void 0===rhng)return new Color(0,0,0,0);if("string"==typeof rhng){if("#"==(rhng=rhng.toUpperCase()).charAt(0)&&(9==rhng.length||7==rhng.length||5==rhng.length||4==rhng.length)){var isShort=4==rhng.length||5==rhng.length,hasAlpha=9==rhng.length||5==rhng.length,length=2,max=255,r,g,b,a_1;return isShort&&(length=1,max=15),new Color(parseInt("0x"+rhng.substr(1,length))/max*255,parseInt("0x"+rhng.substr(1+length,length))/max*255,parseInt("0x"+rhng.substr(1+2*length,length))/max*255,hasAlpha?parseInt("0x"+rhng.substr(1+3*length,length))/max:1)}switch(rhng){case"WHITE":return new Color(255);case"SILVER":return new Color(192);case"GRAY":return new Color(128);case"BLACK":return new Color(0);case"RED":return new Color(255,0,0,1);case"MAROON":return new Color(128,0,0,1);case"YELLOW":return new Color(255,255,0,1);case"OLIVE":return new Color(128,128,0,1);case"LIME":return new Color(0,255,0,1);case"GREEN":return new Color(0,128,0,1);case"AQUA":return new Color(0,255,255,1);case"TEAL":return new Color(0,128,128,1);case"BLUE":return new Color(0,0,255,1);case"NAVY":return new Color(0,0,128,1);case"FUCHSIA":return new Color(255,0,255,1);case"PURPLE":return new Color(128,0,128,1);default:return new Color("LIME")}}void 0!==a?(this.type=Color.RGBA,this.r=Num.constrain(Math.floor(rhng),0,255),this.g=Num.constrain(Math.floor(gsa),0,255),this.b=Num.constrain(Math.floor(bl),0,255),this.a=Num.constrain(a,0,1)):void 0!==bl?(this.type=Color.HSL,this.h=Num.constrain(Math.floor(rhng),0,360),this.s=Num.constrain(Math.floor(gsa),0,100),this.l=Num.constrain(Math.floor(bl),0,100)):(void 0===gsa&&(gsa=1),this.type=Color.RGBA,this.r=rhng,this.g=rhng,this.b=rhng,this.a=gsa)}return Color.prototype.toString=function(){return this.type==Color.RGBA?"rgba("+this.r+","+this.g+","+this.b+","+this.a+")":this.type==Color.HSL?"hsl("+this.h+","+this.s+"%,"+this.l+"%)":"Color is not a valid type."},Color.prototype.copy=function(){return this.type==Color.RGBA?new Color(this.r,this.g,this.b,this.a):new Color(this.h,this.s,this.l)},Color.prototype.applyLight=function(color,intensity){return this.toRGB(),color.type!=Color.RGBA&&(color=Color.toRGB(color)),intensity=intensity<0?0:intensity,this.r=Num.constrain(Math.floor(this.r*(color.r/255)*intensity),0,255),this.g=Num.constrain(Math.floor(this.g*(color.g/255)*intensity),0,255),this.b=Num.constrain(Math.floor(this.b*(color.b/255)*intensity),0,255),this},Color.prototype.toRGB=function(){if(this.type==Color.RGBA)return this;if(0==this.s)return new Color(255*this.l/100);var hue=Num.constrain(this.h/360,0,1),l=Num.constrain(this.l/100,0,1),s=Num.constrain(this.s/100,0,1),temp1=l<.5?l*(1+s):l+s-l*s,temp2=2*l-temp1,hueSplit=function(h){var val=h=h<0?h+1:h>1?h-1:h;return 6*h<1?temp2+6*(temp1-temp2)*h:2*h<=1?temp1:3*h<2?temp2+(temp1-temp2)*(2/3-h)*6:temp2},r=255*hueSplit(hue+1/3),g=255*hueSplit(hue),b=255*hueSplit(hue-1/3);return this.r=r,this.g=g,this.b=b,this.a=1,this.type=Color.RGBA,this},Color.prototype.add=function(color){return this.toRGB(),color.type!=Color.RGBA&&(color=Color.toRGB(color)),this.r=Num.constrain(this.r+color.r,0,255),this.g=Num.constrain(this.g+color.g,0,255),this.b=Num.constrain(this.b+color.b,0,255),this.a=Num.constrain(this.a+color.a,0,1),this},Color.prototype.mult=function(intensity){return this.toRGB(),this.r=Num.constrain(Math.floor(this.r*intensity),0,255),this.g=Num.constrain(Math.floor(this.g*intensity),0,255),this.b=Num.constrain(Math.floor(this.b*intensity),0,255),this},Color.copy=function(c){switch(c.type){case Color.RGBA:return new Color(c.r,c.g,c.b,c.a);case Color.HSL:return new Color(c.h,c.s,c.l)}return c},Color.toString=function(c){return c.toString()},Color.toRGB=function(c){return c.copy().toRGB()},Color.add=function(c0,c1){return c0.copy().add(c1)},Color.applyLight=function(c,l,intensity){return c.copy().applyLight(l,intensity)},Color.mult=function(c,intensity){return c.copy().mult(intensity)},Color.RGBA=0,Color.HSL=1,Color}(),Material=function(){function Material(_a){var _b=void 0===_a?{}:_a,_c=_b.fill,fill=void 0===_c?new Color(200,200,200,1):_c,_d=_b.wire,wire=void 0===_d?null:_d,_e=_b.lit,lit=void 0===_e||_e;this.fill=fill,this.wire=null!==wire?wire:this.fill,this.lit=lit}return Material.prototype.setColor=function(c){return this.fill=c,this.wire=c,this},Material.prototype.setFill=function(c){return this.fill=c,this},Material.prototype.setWire=function(c){return this.wire=c,this},Material.prototype.copy=function(){var fill,wire;return new Material({fill:this.fill.copy(),wire:this.wire.copy(),lit:this.lit})},Material.setColor=function(m,c){return m.copy().setColor(c)},Material.setFill=function(m,c){return m.copy().setFill(c)},Material.setWire=function(m,c){return m.copy().setWire(c)},Material.copy=function(m){return new Material({fill:Color.copy(m.fill),wire:Color.copy(m.wire),lit:m.lit})},Material}(),Fragment=function(){function Fragment(trigon,material,group){this.trigon=trigon,this.material=material,this.group=group}return Fragment.prototype.copy=function(){return new Fragment(this.trigon.copy(),this.material.copy(),this.group)},Fragment.copy=function(f){return new Fragment(Trigon.copy(f.trigon),Material.copy(f.material),f.group)},Fragment}(),Urbject=function(){function Urbject(_a){var _b=void 0===_a?{}:_a,_c=_b.type,type=void 0===_c?Urbject.PARENT:_c,_d=_b.position,position=void 0===_d?new Vector:_d,_e=_b.orientation,orientation=void 0===_e?new Quaternion:_e,_f=_b.scale,scale=void 0===_f?1:_f,superCopy=_b.superCopy,_g=_b.state,state=void 0===_g?Urbject.DYNAMIC:_g,_h=_b.group,group=void 0===_h?0:_h;superCopy?(this.type=superCopy.type,this.position=superCopy.position,this.orientation=superCopy.orientation,this.scaleVector=superCopy.scaleVector,this.children=superCopy.children,this.parent=superCopy.parent,this.state=superCopy.state,this.group=superCopy.group):(this.type=type,this.position=position,this.orientation=orientation.normalize(),this.scaleVector="number"==typeof scale?new Vector(scale,scale,scale):scale,this.children=new Array,this.parent=void 0,this.state=state,this.group=group)}return Urbject.prototype.translate=function(v){return this.position.add(v),this},Urbject.prototype.scale=function(a){return this.scaleVector.mult(a),this},Urbject.prototype.setScale=function(a){return this.scaleVector="number"==typeof a?new Vector(a,a,a):a,this},Urbject.prototype.addChild=function(c){return c.parent&&c.parent.removeChild(c),c.parent=this,this.children.push(c),c},Urbject.prototype.removeChild=function(c){var removed=null;return this.children=this.children.filter((function(urb){var found;return urb===c&&(urb.parent=void 0,removed=urb),removed})),removed},Urbject.prototype.getInstance=function(camera){if(this.state==Urbject.STATIC&&this.instanceCache)return this.instanceCache;for(var lights=new List,frags=new List,i=0;i<this.children.length;i++){var childInstance;switch(this.children[i].type){case Urbject.MESH_URBJECT:case Urbject.PARENT:case Urbject.DIRECTIONAL_LIGHT:case Urbject.AMBIENT_LIGHT:case Urbject.POINT_LIGHT:childInstance=this.children[i].getInstance(camera);break;case Urbject.CAMERA:childInstance=this.children[i].getInstance(camera)}for(var current=childInstance.lights.head;current;){var light=current.data.copy();light.applyTransform(this),lights.addLast(light),current=current.nxt}for(var current=childInstance.fragments.head;current;){var frag=current.data,t=Trigon.applyTransform(frag.trigon,this);frags.addLast(new Fragment(t,frag.material,frag.group)),current=current.nxt}}var instance=new FrameInstance(frags,lights);return this.state==Urbject.STATIC&&(this.instanceCache=instance),instance},Urbject.prototype.applyTransform=function(transform){return this.scale(transform.scaleVector),this.position.mult(transform.scaleVector).quaternionRotate(transform.orientation).add(transform.position),this.orientation.quaternionRotate(transform.orientation),this},Urbject.prototype.getWorldTransform=function(){for(var parent=this.parent,transform=this.copy({shallow:!0});parent;)transform.scale(parent.scaleVector),transform.position.mult(parent.scaleVector).quaternionRotate(parent.orientation).add(parent.position),transform.orientation.quaternionRotate(parent.orientation),parent=parent.parent;return transform},Urbject.prototype.copy=function(options){void 0===options&&(options={shallow:!1});var copy=new Urbject({type:this.type,position:this.position.copy(),orientation:this.orientation.copy(),scale:this.scaleVector.copy(),state:this.state,group:this.group});if(!options.shallow)for(var i=0;i<this.children.length;i++){var child=this.children[i];switch(child.type){case Urbject.PARENT:case Urbject.MESH_URBJECT:case Urbject.DIRECTIONAL_LIGHT:case Urbject.AMBIENT_LIGHT:case Urbject.POINT_LIGHT:case Urbject.CAMERA:copy.addChild(child.copy())}}return copy},Urbject.addChild=function(u,c){return u.copy().addChild(c)},Urbject.removeChild=function(u,c){return u.copy().removeChild(c)},Urbject.applyTransform=function(target,transform){return target.copy().applyTransform(transform)},Urbject.getWorldTransform=function(u){return u.getWorldTransform()},Urbject.getInstance=function(u,camera){return u.getInstance(camera)},Urbject.translate=function(u,v){return u.translate(v)},Urbject.scale=function(u,a){return u.copy().scale(a)},Urbject.setScale=function(u,a){return u.setScale(a)},Urbject.copy=function(u,options){if(void 0===options&&(options={typeCheck:!0,shallow:!1}),options.typeCheck)switch(u.type){case Urbject.PARENT:break;case Urbject.MESH_URBJECT:return MeshUrbject.copy(u,options);case Urbject.DIRECTIONAL_LIGHT:return DirectionalLight.copy(u,options);case Urbject.AMBIENT_LIGHT:return AmbientLight.copy(u,options);case Urbject.POINT_LIGHT:return PointLight.copy(u,options);case Urbject.CAMERA:return Camera.copy(u,options)}var copy=new Urbject({type:u.type,position:Vector.copy(u.position),orientation:Quaternion.copy(u.orientation),scale:Vector.copy(u.scaleVector),state:u.state,group:u.group});if(!options.shallow)for(var i=0;i<u.children.length;i++){var child=u.children[i];switch(child.type){case Urbject.PARENT:copy.addChild(Urbject.copy(child,options));break;case Urbject.MESH_URBJECT:copy.addChild(MeshUrbject.copy(child,options));break;case Urbject.DIRECTIONAL_LIGHT:copy.addChild(DirectionalLight.copy(child,options));break;case Urbject.AMBIENT_LIGHT:copy.addChild(AmbientLight.copy(child,options));break;case Urbject.POINT_LIGHT:copy.addChild(PointLight.copy(child,options));break;case Urbject.CAMERA:copy.addChild(Camera.copy(child,options))}}return copy},Urbject.PARENT=0,Urbject.MESH_URBJECT=1,Urbject.AMBIENT_LIGHT=2,Urbject.DIRECTIONAL_LIGHT=3,Urbject.POINT_LIGHT=4,Urbject.CAMERA=5,Urbject.DYNAMIC=100,Urbject.STATIC=101,Urbject.BILLBOARD=102,Urbject.Z_BILLBOARD=103,Urbject.X_BILLBOARD=104,Urbject.Y_BILLBOARD=105,Urbject.DEFAULT_GROUP=100,Urbject}(),Trigon=function(){function Trigon(v0,v1,v2){void 0===v0&&(v0=new Vector),void 0===v1&&(v1=new Vector),void 0===v2&&(v2=new Vector),this.v0=v0,this.v1=v1,this.v2=v2}return Trigon.prototype.getNormal=function(){var u=Vector.sub(this.v1,this.v0),v=Vector.sub(this.v2,this.v0),dir;return Vector.cross(u,v).normalize()},Trigon.prototype.rotateAxis=function(axis,angle){return this.v0.rotateAxis(axis,angle),this.v1.rotateAxis(axis,angle),this.v2.rotateAxis(axis,angle),this},Trigon.prototype.rotateX=function(angle){return this.rotateAxis(Vector.X_AXIS,angle)},Trigon.prototype.rotateY=function(angle){return this.rotateAxis(Vector.Y_AXIS,angle)},Trigon.prototype.rotateZ=function(angle){return this.rotateAxis(Vector.Z_AXIS,angle)},Trigon.prototype.qRotate=function(q){return this.quaternionRotate(q)},Trigon.prototype.quaternionRotate=function(q){return this.v0.quaternionRotate(q),this.v1.quaternionRotate(q),this.v2.quaternionRotate(q),this},Trigon.prototype.translate=function(v){return this.v0.add(v),this.v1.add(v),this.v2.add(v),this},Trigon.prototype.transform=function(M){return this.v0.transform(M),this.v1.transform(M),this.v2.transform(M),this},Trigon.prototype.scale=function(s){return this.v0.mult(s),this.v1.mult(s),this.v2.mult(s),this},Trigon.prototype.getCenter=function(){return new Vector(Num.avg([this.v0.x,this.v1.x,this.v2.x]),Num.avg([this.v0.y,this.v1.y,this.v2.y]),Num.avg([this.v0.z,this.v1.z,this.v2.z]))},Trigon.prototype.applyTransform=function(transform){return this.quaternionRotate(transform.orientation).scale(transform.scaleVector).translate(transform.position)},Trigon.prototype.inverseNormal=function(){var temp=this.v0;return this.v0=this.v1,this.v1=temp,this},Trigon.prototype.copy=function(){return new Trigon(this.v0.copy(),this.v1.copy(),this.v2.copy())},Trigon.applyTransform=function(target,transform){return target.copy().applyTransform(transform)},Trigon.getNormal=function(t){return t.getNormal()},Trigon.rotateAxis=function(t,axis,angle){return t.copy().rotateAxis(axis,angle)},Trigon.rotateX=function(t,angle){return t.copy().rotateX(angle)},Trigon.rotateY=function(t,angle){return t.copy().rotateY(angle)},Trigon.rotateZ=function(t,angle){return t.copy().rotateZ(angle)},Trigon.qRotate=function(t,q){return Trigon.quaternionRotate(t,q)},Trigon.quaternionRotate=function(t,q){return t.copy().quaternionRotate(q)},Trigon.translate=function(t,v){return t.copy().translate(v)},Trigon.transform=function(t,M){return t.copy().transform(M)},Trigon.scale=function(t,s){return t.copy().scale(s)},Trigon.getCenter=function(t){return t.getCenter()},Trigon.inverseNormal=function(t){return t.copy().inverseNormal()},Trigon.copy=function(t){return new Trigon(Vector.copy(t.v0),Vector.copy(t.v1),Vector.copy(t.v2))},Trigon}(),Quaternion=function(){function Quaternion(a,i,j,k){void 0===a&&(a=1),void 0===i&&(i=0),void 0===j&&(j=0),void 0===k&&(k=0),this.a=a,this.i=i,this.j=j,this.k=k}return Quaternion.prototype.add=function(q){return this.a=this.a+q.a,this.i=this.i+q.i,this.j=this.j+q.j,this.k=this.k+q.k,this},Quaternion.prototype.sub=function(q){return this.a=this.a-q.a,this.i=this.i-q.i,this.j=this.j-q.j,this.k=this.k-q.k,this},Quaternion.prototype.conjugate=function(){return this.i=-this.i,this.j=-this.j,this.k=-this.k,this},Quaternion.prototype.mult=function(a){return this.a=this.a*a,this.i=this.i*a,this.j=this.j*a,this.k=this.k*a,this},Quaternion.prototype.div=function(a){if(0!=a)return this.a=this.a/a,this.i=this.i/a,this.j=this.j/a,this.k=this.k/a,this;console.error("Cannot divide by 0.")},Quaternion.prototype.mag=function(){return Math.sqrt(this.a*this.a+this.i*this.i+this.j*this.j+this.k*this.k)},Quaternion.prototype.normalize=function(){return this.div(this.mag())},Quaternion.prototype.qRotate=function(q){return this.quaternionRotate(q)},Quaternion.prototype.quaternionRotate=function(q){var r=Quaternion.normalize(q).quaternionMult(this.normalize());return this.a=r.a,this.i=r.i,this.j=r.j,this.k=r.k,this},Quaternion.prototype.qMult=function(q){return this.quaternionMult(q)},Quaternion.prototype.quaternionMult=function(q){var r=new Quaternion(this.a*q.a-this.i*q.i-this.j*q.j-this.k*q.k,this.a*q.i+this.i*q.a+this.j*q.k-this.k*q.j,this.a*q.j-this.i*q.k+this.j*q.a+this.k*q.i,this.a*q.k+this.i*q.j-this.j*q.i+this.k*q.a);return this.a=r.a,this.i=r.i,this.j=r.j,this.k=r.k,this},Quaternion.prototype.rotateAxis=function(axis,angle){var q=Quaternion.fromAxisRotation(axis,angle);return this.quaternionRotate(q)},Quaternion.prototype.rotateX=function(a){return this.rotateAxis(Vector.X_AXIS,a)},Quaternion.prototype.rotateY=function(a){return this.rotateAxis(Vector.Y_AXIS,a)},Quaternion.prototype.rotateZ=function(a){return this.rotateAxis(Vector.Z_AXIS,a)},Quaternion.prototype.getRotationMatrix=function(){var a=this.a,i=this.i,j=this.j,k=this.k,M;return[[a*a+i*i-j*j-k*k,2*(i*j-a*k),2*(a*j+i*k)],[2*(i*j+a*k),a*a-i*i+j*j-k*k,2*(-a*i+j*k)],[2*(-a*j+i*k),2*(a*i+j*k),a*a-i*i-j*j+k*k]]},Quaternion.prototype.copy=function(){return new Quaternion(this.a,this.i,this.j,this.k)},Quaternion.sub=function(q0,q1){return q0.copy().sub(q1)},Quaternion.add=function(q0,q1){return q0.copy().add(q1)},Quaternion.conjugate=function(q){return q.copy().conjugate()},Quaternion.mult=function(q,a){return q.copy().mult(a)},Quaternion.div=function(q,a){return q.copy().div(a)},Quaternion.mag=function(q){return q.mag()},Quaternion.normalize=function(q){return q.copy().normalize()},Quaternion.qMult=function(q0,q1){return Quaternion.quaternionMult(q0,q1)},Quaternion.quaternionMult=function(q0,q1){return q0.copy().quaternionMult(q1)},Quaternion.qRotate=function(q0,q1){return this.quaternionRotate(q0,q1)},Quaternion.quaternionRotate=function(q0,q1){return q0.copy().quaternionRotate(q1)},Quaternion.rotateAxis=function(q,axis,angle){return q.copy().rotateAxis(axis,angle)},Quaternion.rotateX=function(q,a){return q.copy().rotateX(a)},Quaternion.rotateY=function(q,a){return q.copy().rotateY(a)},Quaternion.rotateZ=function(q,a){return q.copy().rotateZ(a)},Quaternion.getRotationMatrix=function(q){return q.getRotationMatrix()},Quaternion.copy=function(q){return new Quaternion(q.a,q.i,q.j,q.k)},Quaternion.fromAxisRotation=function(axis,angle){var a=Math.cos(angle/2),s=Math.sin(angle/2);if("number"==typeof axis)var i=axis==Vector.X_AXIS?s:0,j=axis==Vector.Y_AXIS?s:0,k=axis==Vector.Z_AXIS?s:0;else var i=(axis=Vector.normalize(axis)).x*s,j=axis.y*s,k=axis.z*s;return new Quaternion(a,i,j,k).normalize()},Quaternion.fromVector=function(v,reference){if(void 0===reference&&(reference=Vector.xAxis()),v.equals(reference))return new Quaternion(1,0,0,0);var origin=new Vector;if(Vector.neg(v).equals(reference)){var randomLine=Vector.add(reference,new Vector(1,1,1)).normalize();randomLine.equals(reference)&&(randomLine=Vector.add(reference,new Vector(1,1,0)).normalize());var trigon_1=new Trigon(origin,reference,randomLine);return Quaternion.fromAxisRotation(trigon_1.getNormal(),Math.PI)}var x_axis=Vector.axis(Vector.X_AXIS),y_axis=Vector.axis(Vector.Y_AXIS),z_axis=Vector.axis(Vector.Z_AXIS),trigon,normal=new Trigon(origin,reference,v).getNormal(),angle=reference.angleBetween(v),angle_x=normal.angleBetween(x_axis),angle_y=normal.angleBetween(y_axis),angle_z=normal.angleBetween(z_axis),sinHalfAngle=Math.sin(angle/2),quaternion;return new Quaternion(Math.cos(angle/2),Math.cos(angle_x)*sinHalfAngle,Math.cos(angle_y)*sinHalfAngle,Math.cos(angle_z)*sinHalfAngle).normalize()},Quaternion}(),__extends=this&&this.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Camera=function(_super){function Camera(_a){var _b=void 0===_a?{}:_a,_c=_b.orientation,orientation=void 0===_c?Quaternion.fromAxisRotation(Vector.X_AXIS,0):_c,_d=_b.position,position=void 0===_d?new Vector(-10,0,0):_d,scale=_b.scale,_e=_b.fov,fov=void 0===_e?60:_e,superCopy=_b.superCopy,state=_b.state,group=_b.group,_this=_super.call(this,{type:Urbject.CAMERA,position:position,orientation:orientation,scale:scale,superCopy:superCopy,state:state,group:group})||this;return _this.fov=Num.constrain(fov,1,360),_this}return __extends(Camera,_super),Camera.prototype.copy=function(options){return void 0===options&&(options={shallow:!1}),new Camera({superCopy:_super.prototype.copy.call(this,options),fov:this.fov})},Camera.copy=function(c,options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new Camera({superCopy:Urbject.copy(c,{typeCheck:!1,shallow:options.shallow}),fov:c.fov})},Camera}(Urbject),Controller=function(){function Controller(type){void 0===type&&(type=Controller.EMPTY),this.type=type}return Controller.prototype.move=function(target){},Controller.EMPTY=0,Controller.DEFAULT_CAMERA=1,Controller.FOCAL_POINT=2,Controller}(),Interpolate=function(){function Interpolate(){}return Interpolate.range=function(t,start,end,type){if(void 0===type&&(type=Interpolate.LINEAR),t<=0)return start;if(t>=1)return end;var diff=end-start;switch(type){case Interpolate.EASE_IN:return start+diff*t*t;case Interpolate.EASE_OUT:return start+diff*(1-(1-t)*(1-t));case Interpolate.EASE:return start+diff*(t<.5?2*t*t:1-2*Math.pow(1-t,2));default:case Interpolate.LINEAR:return start+diff*t}},Interpolate.EASE=0,Interpolate.EASE_IN=1,Interpolate.EASE_OUT=2,Interpolate.LINEAR=3,Interpolate}(),DefaultCameraController=function(_super){function DefaultCameraController(_a){var _b=void 0===_a?{}:_a,_c=_b.minSpeed,minSpeed=void 0===_c?.5:_c,_d=_b.maxSpeed,maxSpeed=void 0===_d?2:_d,_e=_b.accelerationTime,accelerationTime=void 0===_e?1:_e,_f=_b.accelerationType,accelerationType=void 0===_f?Interpolate.EASE_OUT:_f,_g=_b.controlFace,controlFace=void 0===_g?window:_g,_this=_super.call(this,Controller.DEFAULT_CAMERA)||this;_this.x=0,_this.y=0,_this.dFov=0,_this.minSpeed=minSpeed,_this.maxSpeed=maxSpeed,_this.accelerationTime=accelerationTime,_this.accelerationType=accelerationType,_this.controlFace=controlFace;var controller=_this;return controlFace.addEventListener("mousedown",(function(e){controller.mouseDown(e)})),controlFace.addEventListener("mouseup",(function(e){controller.mouseUp(e)})),controlFace.addEventListener("mousemove",(function(e){controller.mouseMove(e)})),controlFace.addEventListener("wheel",(function(e){controller.wheel(e)})),controlFace.addEventListener("keydown",(function(e){controller.keyDown(e)})),controlFace.addEventListener("keyup",(function(e){controller.keyUp(e)})),_this.lastMove=performance.now(),_this}return __extends(DefaultCameraController,_super),DefaultCameraController.prototype.move=function(camera){var now=performance.now(),elapsedTime=now-this.lastMove;this.lastMove=now,camera.fov=Num.constrain(camera.fov+this.dFov,1,180),this.dFov=0;var fov=camera.fov||60,delta=new Vector(-this.x,this.y,0),dir=Vector.qRotate(new Vector(1,0,0),camera.orientation),dirXY=new Vector(dir.x,dir.y,0),xyMag,xDelta,xAngle=dirXY.mag()*delta.x*Math.PI/1e3*fov/120+dirXY.angleBetween(new Vector(1,0,0))*(dir.y<0?-1:1),yDelta,yAngle=delta.y*Math.PI/1e3*fov/120+dir.angleBetween(dirXY)*(dir.z<0?1:-1);yAngle=Num.constrain(yAngle,-Math.PI/2.01,Math.PI/2.01),dirXY.rotateZ(Math.PI/2);var newOrientation=new Quaternion(1,0,0,0).rotateZ(xAngle).rotateAxis(dirXY,yAngle),moving;if(camera.orientation=newOrientation,this.x=0,this.y=0,this.u||this.d||this.l||this.r||this.f||this.b){this.startMove||(this.startMove=now);var timeSinceStart=now-this.startMove;this.speed=0==timeSinceStart?this.minSpeed:this.getSpeed(timeSinceStart);var movement=new Vector((this.f?1:0)+(this.b?-1:0),(this.l?1:0)+(this.r?-1:0),(this.u?1:0)+(this.d?-1:0)).normalize().mult(this.speed*elapsedTime/100);movement.qRotate(camera.orientation),camera.position.add(movement)}else this.startMove=void 0},DefaultCameraController.prototype.getSpeed=function(t){return t=t/1e3/this.accelerationTime,Interpolate.range(t,this.minSpeed,this.maxSpeed,this.accelerationType)},DefaultCameraController.prototype.mouseDown=function(e){this.mousePressed=!0},DefaultCameraController.prototype.mouseUp=function(e){this.mousePressed=!1},DefaultCameraController.prototype.mouseMove=function(e){this.mousePressed&&(this.x+=e.movementX,this.y+=e.movementY)},DefaultCameraController.prototype.wheel=function(e){if(e.deltaY){var zoomDir=Num.getSign(e.deltaY);this.dFov=5*zoomDir}},DefaultCameraController.prototype.keyDown=function(e){switch(e.key.toUpperCase()){case"W":this.f=!0;break;case"A":this.l=!0;break;case"S":this.b=!0;break;case"D":this.r=!0;break;case"Q":this.d=!0;break;case"E":this.u=!0}},DefaultCameraController.prototype.keyUp=function(e){switch(e.key.toUpperCase()){case"W":this.f=!1;break;case"A":this.l=!1;break;case"S":this.b=!1;break;case"D":this.r=!1;break;case"Q":this.d=!1;break;case"E":this.u=!1}},DefaultCameraController}(Controller),Stats=function(){function Stats(_a){var _b=void 0===_a?{}:_a,_c=_b.show,show=void 0!==_c&&_c,_d=_b.suspendOnBlur,suspendOnBlur=void 0===_d||_d;this.suspended=!1,this.show=show,this.stats={},this.getStatBox(),suspendOnBlur&&this.addSleepListener()}return Stats.prototype.getStatBox=function(){this.statBox=document.getElementById("statBox"),this.statBox||(this.statBox=document.createElement("table"),this.statBox.setAttribute("id","statBox"),this.statBox.setAttribute("style","position: fixed; top: 0; left: 0; overflow-y: auto; max-height: 100vh; color: lime; background-color: #2226; text-align: left; font-family: monospace;"),document.body.append(this.statBox))},Stats.prototype.addSleepListener=function(){var _this=this;window.addEventListener("blur",(function(evt){_this.suspended=!0})),window.addEventListener("focus",(function(evt){_this.suspended=!1;var now=performance.now();_this.timer=now,_this.lastRead=now}))},Stats.prototype.getStat=function(name){return this.stats[name]?this.stats[name].value:void 0},Stats.prototype.setStat=function(name,value,bias,fractionDigits){if(void 0===bias&&(bias=1),void 0===fractionDigits&&(fractionDigits=3),this.stats[name]){var stat_1=this.stats[name];setTimeout((function(){"number"==typeof value&&"number"==typeof stat_1.value?(bias=Num.constrain(bias,0,1),stat_1.value=value*bias+stat_1.value*(1-bias),stat_1.elem.innerHTML=stat_1.value.toFixed(fractionDigits)):(stat_1.value=value,stat_1.elem.innerHTML=""+value)}),0)}else{this.stats[name]={elem:document.createElement("td"),value:value},this.stats[name].elem.setAttribute("id",name),this.stats[name].elem.innerHTML="number"==typeof value?value.toFixed(fractionDigits):value;var row=document.createElement("tr");this.show||row.setAttribute("style","display: none;");var head=document.createElement("td");head.innerHTML=name,row.append(head),row.append(this.stats[name].elem),this.statBox.append(row)}},Stats.prototype.startTimer=function(){this.timer=performance.now(),this.lastRead=this.timer},Stats.prototype.readTimer=function(){if(this.suspended)return 0;var now=performance.now();return this.timer||(this.timer=now),this.lastRead=now,this.lastRead-this.timer},Stats.prototype.readCheckpoint=function(){if(this.suspended)return 0;var now=performance.now();this.lastRead||(this.lastRead=now);var time=now-this.lastRead;return this.lastRead=now,time},Stats}(),UrchinWorker=function(){function UrchinWorker(type,showPerformance){void 0===showPerformance&&(showPerformance=!1),this.type=type,this.working=!1,this.worker=new Worker(URCHIN_PATH,{name:""+type}),this.stats=new Stats({show:showPerformance})}return UrchinWorker.prototype.assign=function(assignment){this.queue=assignment},UrchinWorker.prototype.getAssignment=function(){if(this.queue){var assignment=this.queue;return this.queue=void 0,this.working=!0,assignment}return this.working=!1,null},UrchinWorker.prototype.workOn=function(assignment){},UrchinWorker.prototype.report=function(data){},UrchinWorker.SORTING=0,UrchinWorker.LIGHTING=1,UrchinWorker.PROJECTING=2,UrchinWorker.RENDER=3,UrchinWorker}(),FrameInstance=function(){function FrameInstance(fragments,lights,camera){this.fragments=fragments,this.lights=lights,this.camera=camera}return FrameInstance.prototype.copy=function(){return new FrameInstance(this.fragments.copy(),this.lights.copy(),this.camera?this.camera.copy({shallow:!0}):void 0)},FrameInstance.copy=function(i){return i.copy()},FrameInstance}(),LightingWorker=function(_super){function LightingWorker(callback,showPerformance){void 0===callback&&(callback=function(data){}),void 0===showPerformance&&(showPerformance=!1);var _this=_super.call(this,UrchinWorker.LIGHTING,showPerformance)||this,w=_this;return _this.worker.addEventListener("message",(function(evt){w.report(evt.data)})),_this.callback=callback,_this}return __extends(LightingWorker,_super),LightingWorker.prototype.assign=function(assignment){if(_super.prototype.assign.call(this,assignment),!this.working){var assignment_1=this.getAssignment();assignment_1&&this.workOn(assignment_1)}},LightingWorker.prototype.workOn=function(assignment){this.stats.startTimer();for(var frags=assignment.fragments,buffer=new ArrayBuffer(4*frags.count*LightingWorker.FRAG_SIZE),current=frags.head,i=0;i<frags.count&&current;i++){for(var fragView=new Float32Array(buffer,4*LightingWorker.FRAG_SIZE*i,LightingWorker.FRAG_SIZE),t=current.data.trigon,f=Color.toRGB(current.data.material.fill),w=Color.toRGB(current.data.material.wire),fragData=[t.v0.x,t.v0.y,t.v0.z,t.v1.x,t.v1.y,t.v1.z,t.v2.x,t.v2.y,t.v2.z,f.r,f.g,f.b,f.a,w.r,w.g,w.b,w.a,current.data.material.lit?1:0],n=0;n<fragData.length;n++)fragView[n]=fragData[n];current=current.nxt}this.worker.postMessage({buffer:buffer,lights:assignment.lights},[buffer]),this.stats.setStat("Lighting Worker Send",this.stats.readTimer(),.1,3),this.stats.startTimer()},LightingWorker.prototype.report=function(data){var dataView=new Float32Array(data.buffer);this.working=!1,this.stats.setStat("Lighting Worker Process",this.stats.readTimer(),.1,3),this.callback(dataView)},LightingWorker.DATA_SIZE=8,LightingWorker.FRAG_SIZE=18,LightingWorker}(UrchinWorker),Mesh=function(){function Mesh(){this.trigons=new Array}return Mesh.prototype.rotateAxis=function(axis,angle){for(var i=0;i<this.trigons.length;i++)this.trigons[i].rotateAxis(axis,angle);return this},Mesh.prototype.rotateX=function(angle){return this.rotateAxis(Vector.X_AXIS,angle)},Mesh.prototype.rotateY=function(angle){return this.rotateAxis(Vector.Y_AXIS,angle)},Mesh.prototype.rotateZ=function(angle){return this.rotateAxis(Vector.Z_AXIS,angle)},Mesh.prototype.qRotate=function(q){return this.quaternionRotate(q)},Mesh.prototype.quaternionRotate=function(q){for(var i=0;i<this.trigons.length;i++)this.trigons[i].quaternionRotate(q);return this},Mesh.prototype.translate=function(v){for(var i=0;i<this.trigons.length;i++)this.trigons[i].translate(v);return this},Mesh.prototype.transform=function(M){for(var i=0;i<this.trigons.length;i++)this.trigons[i].transform(M);return this},Mesh.prototype.scale=function(s){for(var i=0;i<this.trigons.length;i++)this.trigons[i].scale(s);return this},Mesh.prototype.addTrigon=function(t){if(Array.isArray(t))for(var i=0;i<t.length;i++)this.trigons.push(t[i].copy());else this.trigons.push(t.copy());return t},Mesh.prototype.generateFromArrayData=function(v){for(var i=0;i<v.length;i+=9){var t=new Trigon(new Vector(v[i+0],v[i+1],v[i+2]),new Vector(v[i+3],v[i+4],v[i+5]),new Vector(v[i+6],v[i+7],v[i+8]));this.addTrigon(t)}return this},Mesh.prototype.inverseNormals=function(){for(var i=0;i<this.trigons.length;i++)this.trigons[i].inverseNormal();return this},Mesh.prototype.copy=function(){for(var copy=new Mesh,i=0;i<this.trigons.length;i++)copy.addTrigon(this.trigons[i].copy());return copy},Mesh.rotateAxis=function(m,axis,angle){return m.copy().rotateAxis(axis,angle)},Mesh.rotateX=function(m,angle){return m.copy().rotateX(angle)},Mesh.rotateY=function(m,angle){return m.copy().rotateY(angle)},Mesh.rotateZ=function(m,angle){return m.copy().rotateZ(angle)},Mesh.qRotate=function(m,q){return m.copy().qRotate(q)},Mesh.quaternionRotate=function(m,q){return m.copy().quaternionRotate(q)},Mesh.translate=function(m,v){return m.copy().translate(v)},Mesh.transform=function(m,M){return m.copy().transform(M)},Mesh.scale=function(m,s){return m.copy().scale(s)},Mesh.addTrigon=function(m,t){var mesh=m.copy();return mesh.addTrigon(t),mesh},Mesh.generateFromArrayData=function(v){var m;return(new Mesh).generateFromArrayData(v)},Mesh.inverseNormals=function(m){return m.copy().inverseNormals()},Mesh.copy=function(m){for(var copy=new Mesh,i=0;i<m.trigons.length;i++)copy.addTrigon(Trigon.copy(m.trigons[i]));return copy},Mesh.plane=function(){var plane=new Mesh;return plane.generateFromArrayData([0,0,0,1,0,0,0,1,0,1,1,0,0,1,0,1,0,0]),plane.translate(new Vector(-.5,-.5,0)),plane},Mesh.cube=function(){for(var cube=new Mesh,p=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],vectorPoints=[0,4,1,5,1,4,6,2,7,3,7,2,0,1,2,3,2,1,5,4,7,6,7,4,5,7,1,3,1,7,0,2,4,2,6,4],vectorArray=new Array,i=0;i<vectorPoints.length;i++){var point=p[vectorPoints[i]];vectorArray.push(point[0]),vectorArray.push(point[1]),vectorArray.push(point[2])}return cube.generateFromArrayData(vectorArray),cube.translate(new Vector(-.5,-.5,-.5)),cube},Mesh.circle=function(options){void 0===options&&(options={}),void 0===options.resolution&&(options.resolution=16),void 0===options.radius&&(options.radius=.5),options.resolution<3&&(options.resolution=3);for(var circle=new Mesh,angle=0,step=2*Math.PI/options.resolution,i=0;i<options.resolution;i++){var t=new Trigon(new Vector,new Vector(Math.cos(angle),Math.sin(angle),0).mult(options.radius),new Vector(Math.cos(angle+step),Math.sin(angle+step),0).mult(options.radius));circle.addTrigon(t),angle+=step}return circle},Mesh.cylinder=function(options){void 0===options&&(options={}),void 0===options.resolution&&(options.resolution=16),void 0===options.innerRadius&&(options.innerRadius=0),void 0===options.outerRadius&&(options.outerRadius=.5),void 0===options.height&&(options.height=1);for(var res=options.resolution<3?3:options.resolution,outR=options.outerRadius,inR=options.innerRadius,hasCenter=0!=inR,hasEnds=outR!=inR,h=options.height,hasSides=0!=h,cylinder=new Mesh,angle=0,step=2*Math.PI/res,i=0;i<res;i++){var c0=new Vector(Math.cos(angle),Math.sin(angle),1),c1=new Vector(Math.cos(angle+step),Math.sin(angle+step),1),p=[Vector.mult(c0,new Vector(outR,outR,h/2)),Vector.mult(c1,new Vector(outR,outR,h/2)),Vector.mult(c0,new Vector(inR,inR,h/2)),Vector.mult(c1,new Vector(inR,inR,h/2)),Vector.mult(c0,new Vector(outR,outR,-h/2)),Vector.mult(c1,new Vector(outR,outR,-h/2)),Vector.mult(c0,new Vector(inR,inR,-h/2)),Vector.mult(c1,new Vector(inR,inR,-h/2))],outerEnds=[new Trigon(p[0],p[1],p[2]),new Trigon(p[5],p[4],p[6])],innerEnds=[new Trigon(p[2],p[1],p[3]),new Trigon(p[5],p[6],p[7])],outer=[new Trigon(p[0],p[4],p[5]),new Trigon(p[5],p[1],p[0])],inner=[new Trigon(p[2],p[3],p[7]),new Trigon(p[7],p[6],p[2])];hasEnds&&(cylinder.addTrigon(outerEnds),hasCenter&&cylinder.addTrigon(innerEnds)),hasSides&&(cylinder.addTrigon(outer),hasCenter&&cylinder.addTrigon(inner)),angle+=step}return cylinder},Mesh.sphere=function(options){void 0===options&&(options={}),void 0===options.subdivisions&&(options.subdivisions=3),void 0===options.radius&&(options.radius=.5),options.subdivisions<1&&(options.subdivisions=1);for(var sphere=new Mesh,t=(1+Math.sqrt(5))/2,p=[[-1,0,t],[1,0,t],[-1,0,-t],[1,0,-t],[0,-t,-1],[0,-t,1],[0,t,-1],[0,t,1],[t,1,0],[t,-1,0],[-t,1,0],[-t,-1,0]],vectorPoints=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],vectorArray=new Array,i=0;i<vectorPoints.length;i++){var point=p[vectorPoints[i]],v=new Vector(point[0],point[1],point[2]).normalize();vectorArray.push(v.x),vectorArray.push(v.y),vectorArray.push(v.z)}if(sphere.generateFromArrayData(vectorArray),options.subdivisions>1)for(var i=1;i<options.subdivisions;i++){var trigons=sphere.trigons;sphere.trigons=new Array;for(var n=0;n<trigons.length;n++){var t_1=trigons[n],m01=Vector.add(t_1.v0,t_1.v1).div(2).normalize(),m12=Vector.add(t_1.v1,t_1.v2).div(2).normalize(),m20=Vector.add(t_1.v0,t_1.v2).div(2).normalize(),t0=new Trigon(t_1.v0,m01,m20),t1=new Trigon(m01.copy(),t_1.v1,m12),t2=new Trigon(m20.copy(),m12.copy(),t_1.v2),t3=new Trigon(m01.copy(),m12.copy(),m20.copy());sphere.addTrigon([t0,t1,t2,t3])}}return sphere.scale(options.radius),sphere},Mesh.uvSphere=function(options){void 0===options&&(options={}),void 0===options.resolution&&(options.resolution=16),void 0===options.radius&&(options.radius=.5),options.resolution<3&&(options.resolution=3);for(var sphere=new Mesh,circle=Mesh.circle({resolution:options.resolution,radius:1}),lastCircle=circle.copy(),numLayers=Math.ceil(options.resolution/4),a=0;a<numLayers;a++){for(var angle=Math.PI/2*(a+1)*1/numLayers,height=Math.sin(angle),layerCircle=circle.copy().scale(Math.cos(angle)).translate(new Vector(0,0,height)),i=0;i<circle.trigons.length;i++){var t0_t=lastCircle.trigons[i],t1_t=layerCircle.trigons[i],t0_b=Trigon.scale(t0_t,new Vector(1,1,-1)),t1_b=Trigon.scale(t1_t,new Vector(1,1,-1));sphere.addTrigon(new Trigon(t0_t.v1,t0_t.v2,t1_t.v2)),sphere.addTrigon(new Trigon(t0_b.v2,t0_b.v1,t1_b.v1)),a+1!=numLayers&&(sphere.addTrigon(new Trigon(t1_t.v2,t1_t.v1,t0_t.v1)),sphere.addTrigon(new Trigon(t1_b.v1,t1_b.v2,t0_b.v2)))}lastCircle=layerCircle}return sphere.scale(options.radius)},Mesh}(),DirectionalLight=function(_super){function DirectionalLight(_a){var _b=void 0===_a?{}:_a,_c=_b.direction,direction=void 0===_c?new Vector(1,1,-4):_c,_d=_b.brightness,brightness=void 0===_d?1.1:_d,_e=_b.color,color=void 0===_e?new Color("WHITE"):_e,superCopy=_b.superCopy,state=_b.state,group=_b.group,_this=_super.call(this,{type:Urbject.DIRECTIONAL_LIGHT,superCopy:superCopy,orientation:Quaternion.fromVector(direction),state:state,group:group})||this;return _this.brightness=brightness,_this.color=color,_this}return __extends(DirectionalLight,_super),DirectionalLight.prototype.getInstance=function(camera){if(!this.instanceCache){var instance=_super.prototype.getInstance.call(this,camera);return instance.lights.addFirst(this.copy({shallow:!0})),instance}return _super.prototype.getInstance.call(this,camera)},DirectionalLight.prototype.intensityOn=function(t){var norm=t.getNormal();return Num.constrain((Vector.quaternionRotate(Vector.axis(Vector.X_AXIS),this.orientation).angleBetween(norm)-Math.PI/2)/(Math.PI/2),0,1)*this.brightness},DirectionalLight.prototype.copy=function(options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new DirectionalLight({superCopy:_super.prototype.copy.call(this,options),color:this.color.copy(),brightness:this.brightness})},DirectionalLight.getInstance=function(l,camera){return l.getInstance(camera)},DirectionalLight.intensityOn=function(l,t){return l.intensityOn(t)},DirectionalLight.copy=function(l,options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new DirectionalLight({superCopy:Urbject.copy(l,{typeCheck:!1,shallow:options.shallow}),color:Color.copy(l.color),brightness:l.brightness})},DirectionalLight}(Urbject),AmbientLight=function(_super){function AmbientLight(_a){var _b=void 0===_a?{}:_a,_c=_b.brightness,brightness=void 0===_c?.6:_c,_d=_b.color,color=void 0===_d?new Color("WHITE"):_d,superCopy=_b.superCopy,state=_b.state,group=_b.group,_this=_super.call(this,{type:Urbject.AMBIENT_LIGHT,superCopy:superCopy,state:state,group:group})||this;return _this.brightness=brightness,_this.color=color,_this}return __extends(AmbientLight,_super),AmbientLight.prototype.getInstance=function(camera){if(!this.instanceCache){var instance=_super.prototype.getInstance.call(this,camera);return instance.lights.addFirst(this.copy({shallow:!0})),instance}return _super.prototype.getInstance.call(this,camera)},AmbientLight.prototype.intensityOn=function(t){return this.brightness},AmbientLight.prototype.copy=function(options){void 0===options&&(options={shallow:!1});var superCopy=_super.prototype.copy.call(this,options),copy;return new AmbientLight({brightness:this.brightness,color:this.color.copy(),superCopy:superCopy})},AmbientLight.getInstance=function(l,camera){return l.getInstance(camera)},AmbientLight.intensityOn=function(l,t){return l.intensityOn(t)},AmbientLight.copy=function(l,options){void 0===options&&(options={shallow:!1});var superCopy=Urbject.copy(l,{typeCheck:!1,shallow:options.shallow}),copy;return new AmbientLight({brightness:l.brightness,color:Color.copy(l.color),superCopy:superCopy})},AmbientLight}(Urbject),MeshUrbject=function(_super){function MeshUrbject(_a){var _b=void 0===_a?{}:_a,position=_b.position,orientation=_b.orientation,scale=_b.scale,state=_b.state,group=_b.group,_c=_b.mesh,mesh=void 0===_c?new Mesh:_c,_d=_b.material,material=void 0===_d?new Material:_d,superCopy=_b.superCopy,_this=_super.call(this,{type:Urbject.MESH_URBJECT,superCopy:superCopy,position:position,orientation:orientation,scale:scale,state:state,group:group})||this;return _this.mesh=mesh,_this.material=material,_this}return __extends(MeshUrbject,_super),MeshUrbject.prototype.copy=function(options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new MeshUrbject({superCopy:_super.prototype.copy.call(this,options),mesh:this.mesh.copy(),material:this.material.copy()})},MeshUrbject.prototype.getInstance=function(camera){if(this.state==Urbject.STATIC&&this.instanceCache)return this.instanceCache;var frags=new List,trigons=this.mesh.trigons,trigonRotation=this.orientation.copy();switch(this.state){default:case Urbject.DYNAMIC:break;case Urbject.BILLBOARD:case Urbject.X_BILLBOARD:case Urbject.Y_BILLBOARD:case Urbject.Z_BILLBOARD:var norm=Vector.axis(Vector.X_AXIS),center=this.position,diff=Vector.sub(camera.position,center);this.state==Urbject.X_BILLBOARD&&(diff.x=0),this.state==Urbject.Y_BILLBOARD&&(diff.y=0),this.state==Urbject.Z_BILLBOARD&&(diff.z=0);var axis=new Trigon(new Vector,norm,diff).getNormal();trigonRotation.quaternionRotate(Quaternion.fromAxisRotation(axis,diff.angleBetween(norm)))}for(var n=0;n<trigons.length;n++){var t=Trigon.scale(trigons[n],this.scaleVector).quaternionRotate(trigonRotation).translate(this.position);frags.addFirst(new Fragment(t,this.material,this.group+Urbject.DEFAULT_GROUP))}var childrenInstance=_super.prototype.getInstance.call(this,camera);frags.linkLast(childrenInstance.fragments);var instance=new FrameInstance(frags,childrenInstance.lights);return this.state==Urbject.STATIC&&(this.instanceCache=instance),instance},MeshUrbject.getInstance=function(u,camera){return u.getInstance(camera)},MeshUrbject.copy=function(u,options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new MeshUrbject({superCopy:Urbject.copy(u,{typeCheck:!1,shallow:options.shallow}),mesh:Mesh.copy(u.mesh),material:Material.copy(u.material)})},MeshUrbject}(Urbject),Scene=function(){function Scene(_a){var _b=(void 0===_a?{}:_a).root,root=void 0===_b?new Urbject:_b;this.root=root}return Scene.prototype.add=function(urbject){return this.root.addChild(urbject)},Scene.prototype.remove=function(urbject){return this.root.removeChild(urbject)},Scene.prototype.copy=function(){return new Scene({root:this.root.copy()})},Scene.add=function(s,urbject){var scene=s.copy();return scene.add(urbject),scene},Scene.remove=function(s,urbject){var scene=s.copy();return scene.remove(urbject),scene},Scene.copy=function(u){return new Scene({root:Urbject.copy(u.root)})},Scene}(),Renderer=function(){function Renderer(_a){var _b=void 0===_a?{}:_a,_c=_b.canvas,canvas=void 0===_c?document.querySelector("canvas")||function a(){var canvas=document.createElement("canvas");return canvas.width=720,canvas.height=480,document.body.append(canvas),canvas}():_c,_d=_b.fullscreen,fullscreen=void 0!==_d&&_d,_e=_b.superSampling,superSampling=void 0===_e?1:_e,_f=_b.backgroundColor,backgroundColor=void 0===_f?new Color("silver"):_f,_g=_b.showPerformance,showPerformance=void 0!==_g&&_g,_h=_b.suspendOnBlur,suspendOnBlur=void 0===_h||_h;if(this.backgroundColor=backgroundColor,this.canvas=canvas,this.superSampling=superSampling,this.stats=new Stats({show:showPerformance,suspendOnBlur:suspendOnBlur}),fullscreen){this.canvas.setAttribute("style",this.canvas.getAttribute("style")+";position: fixed; width: 100%; height: 100%;");var renderer_1=this;window.addEventListener("resize",(function(){renderer_1.resize()})),this.resize()}else 1!=this.superSampling&&(this.canvas.setAttribute("style",this.canvas.getAttribute("style")+";width: "+this.canvas.width+"px; height: "+this.canvas.height+"px;"),this.canvas.width=this.canvas.width*this.superSampling,this.canvas.height=this.canvas.height*this.superSampling)}return Renderer.prototype.render=function(scene,camera){if(!this.stats.suspended){if(this.lastDraw){var frameTime,fps=1e3/this.stats.readTimer();this.stats.setStat("FPS",fps,.1,0)}this.stats.startTimer();var instance=Renderer.getCameraInstance(scene,camera),lights=instance.lights,frags=instance.fragments;camera=instance.camera,this.stats.setStat("Gathering Instance Data",this.stats.readCheckpoint(),.1,3),frags=Renderer.sortFragments(frags),this.stats.setStat("Sorting Fragments",this.stats.readCheckpoint(),.1,3);var data=new ArrayBuffer(4*(Renderer.DRAW_HEADER_SIZE+Renderer.DRAW_FRAG_SIZE*frags.count)),color=Color.toRGB(this.backgroundColor),headerView=new Float32Array(data,0,Renderer.DRAW_HEADER_SIZE);headerView[0]=color.r,headerView[1]=color.g,headerView[2]=color.b,headerView[3]=color.a,headerView[4]=this.canvas.width,headerView[5]=this.canvas.height;for(var node=frags.head,num=0;node;){var frag=node.data,t=Trigon.translate(frag.trigon,Vector.neg(camera.position));t.quaternionRotate(Quaternion.conjugate(camera.orientation));var p0=Renderer.project(t.v0,camera.fov,this.canvas.width,this.canvas.height),p1=Renderer.project(t.v1,camera.fov,this.canvas.width,this.canvas.height),p2=Renderer.project(t.v2,camera.fov,this.canvas.width,this.canvas.height);if(frag.material.lit)var mat=Renderer.light(frag,lights),fill=mat.fill,wire=mat.wire;else var fill=Color.toRGB(frag.material.fill),wire=Color.toRGB(frag.material.wire);for(var fragView=new Float32Array(data,4*(Renderer.DRAW_HEADER_SIZE+num*Renderer.DRAW_FRAG_SIZE),Renderer.DRAW_FRAG_SIZE),fragData=[p0.x,p0.y,p1.x,p1.y,p2.x,p2.y,fill.r,fill.g,fill.b,fill.a,wire.r,wire.g,wire.b,wire.a],i=0;i<fragView.length;i++)fragView[i]=fragData[i];num++,node=node.nxt}this.stats.setStat("Building Draw Data",this.stats.readCheckpoint(),.1,3),this.ctx||(this.ctx=this.canvas.getContext("2d")),Renderer.draw(data,this.ctx),this.lastDraw=data,this.stats.setStat("Draw Time",this.stats.readCheckpoint(),.1,3)}},Renderer.prototype.resize=function(width,height){void 0===width&&(width=window.innerWidth),void 0===height&&(height=window.innerHeight),this.canvas.width=width*this.superSampling,this.canvas.height=height*this.superSampling,this.lastDraw&&this.ctx&&Renderer.draw(this.lastDraw,this.ctx)},Renderer.prototype.project=function(v,camera,superSamplePosition){void 0===superSamplePosition&&(superSamplePosition=!1);var w=this.canvas.width/(superSamplePosition?1:this.superSampling),h=this.canvas.height/(superSamplePosition?1:this.superSampling),worldPos=camera.getWorldTransform();return Renderer.project(v.sub(worldPos.position).quaternionRotate(worldPos.orientation.conjugate()),camera.fov,w,h)},Renderer.draw=function(data,ctx){var headerData=new Float32Array(data,0,Renderer.DRAW_HEADER_SIZE);if(ctx.save(),headerData[3]>0){var fill_1=new Color(headerData[0],headerData[1],headerData[2],headerData[3]).toString();ctx.fillStyle=fill_1,ctx.beginPath(),ctx.rect(0,0,headerData[4],headerData[5]),ctx.fill()}else ctx.clearRect(0,0,headerData[4],headerData[5]);ctx.lineJoin="round",ctx.lineCap="round",ctx.lineWidth=1;for(var i=4*Renderer.DRAW_HEADER_SIZE;i<data.byteLength;i+=4*Renderer.DRAW_FRAG_SIZE){var drawData=new Float32Array(data,i,Renderer.DRAW_FRAG_SIZE),x0=drawData[0],y0=drawData[1],x1=drawData[2],y1=drawData[3],x2=drawData[4],y2=drawData[5],fill="rgba("+drawData[6]+", "+drawData[7]+", "+drawData[8]+", "+drawData[9]+")",stroke="rgba("+drawData[10]+", "+drawData[11]+", "+drawData[12]+", "+drawData[13]+")";ctx.fillStyle=fill,ctx.strokeStyle=stroke,ctx.beginPath(),ctx.moveTo(x0,y0),ctx.lineTo(x1,y1),ctx.lineTo(x2,y2),ctx.closePath(),ctx.fill(),ctx.stroke()}ctx.restore()},Renderer.light=function(frag,lights){for(var fill=Color.toRGB(frag.material.fill),wire=Color.toRGB(frag.material.wire),totalLight=new Color,light=lights.head;light;){var intensity=light.data.intensityOn(frag.trigon);totalLight.add(Color.mult(light.data.color,intensity)),light=light.nxt}return fill.applyLight(totalLight,1),wire.applyLight(totalLight,1),new Material({fill:fill,wire:wire})},Renderer.project=function(v,fov,w,h){fov*=2*Math.PI/360;var d=Math.sqrt(w*w+h*h),wFov=fov*w/d,hFov=fov*h/d,diffXZ=new Vector(v.x,0,v.z),diffXY=new Vector(v.x,-v.y,0),angleY=diffXZ.angleBetween(Vector.axis(Vector.X_AXIS)),angleX=diffXY.angleBetween(Vector.axis(Vector.X_AXIS)),screenPos=new Vector((v.y<0?1:-1)*angleX/(wFov/2),(v.z<0?1:-1)*angleY/(hFov/2),0);return screenPos.mult(new Vector(w/2,h/2,0)),screenPos.add(new Vector(w/2,h/2,0)),screenPos},Renderer.getCameraInstance=function(scene,camera){var worldCamera=camera.getWorldTransform();worldCamera.fov=camera.fov,camera=worldCamera;for(var instance=scene.root.getInstance(camera),frags=new List,cameraDir=Vector.axis(Vector.X_AXIS),current=instance.fragments.head;current;){var t=Trigon.translate(current.data.trigon,Vector.neg(camera.position)),m0=t.v0.mag(),m1=t.v1.mag(),m2=t.v2.mag(),far=m0>m1?m0>m2?t.v0:t.v2:m1>m2?t.v1:t.v2,near=m0<m1?m0<m2?t.v0:t.v2:m1<m2?t.v1:t.v2,center=t.getCenter(),diff,dist=Vector.add(near,far).mult(.475).add(Vector.mult(center,.05)).mag(),normal=t.getNormal(),facingAngle,viewAngle;if(Vector.angleBetween(center,normal)>Math.PI/2)t.quaternionRotate(Quaternion.conjugate(camera.orientation)),Math.min(Math.min(Vector.angleBetween(cameraDir,t.v0),Vector.angleBetween(cameraDir,t.v1)),Vector.angleBetween(cameraDir,t.v2))<=180*Math.PI/360&&frags.addLast(current.data,dist);current=current.nxt}return new FrameInstance(frags,instance.lights,camera)},Renderer.sortFragments=function(fragments){for(var groups=new Array,minGroup=Urbject.DEFAULT_GROUP,maxGroup=Urbject.DEFAULT_GROUP,min=fragments.minPriority,max,diff=fragments.maxPriority-min,current=fragments.head;current;){var group=current.data.group;group<minGroup&&(minGroup=group),group>maxGroup&&(maxGroup=group);var bucketNum=diff?Math.floor(fragments.count*(current.priority-min)/diff):0,fragBuckets;groups[group]||(groups[group]=new Array(fragments.count)),(fragBuckets=groups[group])[bucketNum]||(fragBuckets[bucketNum]=new List),fragBuckets[bucketNum].addByPriority(current.data,current.priority),current=current.nxt}for(var sortedFrags=new List,g=maxGroup;g>=minGroup;g--){var fragBuckets;if(fragBuckets=groups[g])for(var i=0;i<fragBuckets.length;i++)fragBuckets[i]&&sortedFrags.linkFirst(fragBuckets[i])}return sortedFrags},Renderer.DRAW_HEADER_SIZE=6,Renderer.DRAW_FRAG_SIZE=14,Renderer}(),SortingWorker=function(_super){function SortingWorker(callback,showPerformance){void 0===callback&&(callback=function(data){}),void 0===showPerformance&&(showPerformance=!1);var _this=_super.call(this,UrchinWorker.SORTING,showPerformance)||this,w=_this;return _this.worker.addEventListener("message",(function(evt){w.report(evt.data)})),_this.callback=callback,_this}return __extends(SortingWorker,_super),SortingWorker.prototype.assign=function(assignment){if(_super.prototype.assign.call(this,assignment),!this.working){var assignment_2=this.getAssignment();assignment_2&&this.workOn(assignment_2)}},SortingWorker.prototype.workOn=function(assignment){this.stats.startTimer();for(var buffer=new ArrayBuffer(assignment.count*SortingWorker.FRAG_SIZE*4),bufferView=new Float32Array(buffer),extremes=new Array,minGroup=Urbject.DEFAULT_GROUP,maxGroup=Urbject.DEFAULT_GROUP,current=assignment.head,i=0;i<assignment.count&&current;i++){var dist=current.priority,group=current.data.group;group<minGroup&&(minGroup=group),group>maxGroup&&(maxGroup=group),extremes[group]||(extremes[group]={min:dist,max:dist}),group<extremes[group].min&&(extremes[group].min=group),group>extremes[group].max&&(extremes[group].max=group),bufferView[i*SortingWorker.FRAG_SIZE]=i,bufferView[i*SortingWorker.FRAG_SIZE+1]=dist,bufferView[i*SortingWorker.FRAG_SIZE+2]=group,current=current.nxt}this.worker.postMessage({buffer:buffer,extremes:extremes,minGroup:minGroup,maxGroup:maxGroup},[buffer]),this.stats.setStat("Sorting Worker Send",this.stats.readTimer(),.1,3),this.stats.startTimer()},SortingWorker.prototype.report=function(data){var dataView=new Float32Array(data.buffer);this.working=!1,this.stats.setStat("Sorting Worker Process",this.stats.readTimer(),.1,3),this.callback(dataView)},SortingWorker.DATA_SIZE=1,SortingWorker.FRAG_SIZE=3,SortingWorker}(UrchinWorker),ProjectingWorker=function(_super){function ProjectingWorker(callback,showPerformance){void 0===callback&&(callback=function(data){}),void 0===showPerformance&&(showPerformance=!1);var _this=_super.call(this,UrchinWorker.PROJECTING,showPerformance)||this,w=_this;return _this.worker.addEventListener("message",(function(evt){w.report(evt.data)})),_this.callback=callback,_this}return __extends(ProjectingWorker,_super),ProjectingWorker.prototype.assign=function(assignment){if(_super.prototype.assign.call(this,assignment),!this.working){var assignment_3=this.getAssignment();assignment_3&&this.workOn(assignment_3)}},ProjectingWorker.prototype.workOn=function(assignment){this.stats.startTimer();for(var frags=assignment.instance.fragments,buffer=new ArrayBuffer(4*frags.count*ProjectingWorker.FRAG_SIZE),current=frags.head,i=0;i<frags.count&&current;i++){for(var fragView=new Float32Array(buffer,4*ProjectingWorker.FRAG_SIZE*i,ProjectingWorker.FRAG_SIZE),t=current.data.trigon,fragData=[t.v0.x,t.v0.y,t.v0.z,t.v1.x,t.v1.y,t.v1.z,t.v2.x,t.v2.y,t.v2.z],n=0;n<fragData.length;n++)fragView[n]=fragData[n];current=current.nxt}this.worker.postMessage({buffer:buffer,camera:assignment.instance.camera,width:assignment.width,height:assignment.height},[buffer]),this.stats.setStat("Projecting Worker Send",this.stats.readTimer(),.1,3),this.stats.startTimer()},ProjectingWorker.prototype.report=function(data){var dataView=new Float32Array(data.buffer);this.working=!1,this.stats.setStat("Projecting Worker Process",this.stats.readTimer(),.1,3),this.callback(dataView)},ProjectingWorker.DATA_SIZE=6,ProjectingWorker.FRAG_SIZE=9,ProjectingWorker}(UrchinWorker),RenderWorker=function(_super){function RenderWorker(canvas,callback,sync,showPerformance){void 0===callback&&(callback=function(){}),void 0===sync&&(sync=function(){}),void 0===showPerformance&&(showPerformance=!1);var _this=_super.call(this,UrchinWorker.RENDER,showPerformance)||this;_this.sync=function(){};var w=_this;_this.worker.addEventListener("message",(function(evt){w.report(evt.data)})),_this.callback=callback,_this.sync=sync;var offscreen=canvas.transferControlToOffscreen();return _this.worker.postMessage({canvas:offscreen},[offscreen]),_this}return __extends(RenderWorker,_super),RenderWorker.prototype.resize=function(width,height){this.worker.postMessage({dimensions:{width:width,height:height}})},RenderWorker.prototype.assign=function(assignment){if(_super.prototype.assign.call(this,assignment),!this.working){var assignment_4=this.getAssignment();assignment_4&&this.workOn(assignment_4)}},RenderWorker.prototype.workOn=function(assignment){this.stats.startTimer(),this.worker.postMessage({buffer:assignment},[assignment]),this.stats.setStat("Render Worker Send",this.stats.readTimer(),.1,3),this.stats.startTimer(),this.sync()},RenderWorker.prototype.report=function(data){this.working=!1,this.stats.setStat("Render Worker Process",this.stats.readTimer(),.1,3),this.callback();var assignment=this.getAssignment();assignment&&this.workOn(assignment)},RenderWorker}(UrchinWorker),PerformanceRenderer=function(_super){function PerformanceRenderer(_a){var _b=void 0===_a?{}:_a,canvas=_b.canvas,_c=_b.fullscreen,fullscreen=void 0!==_c&&_c,superSampling=_b.superSampling,backgroundColor=_b.backgroundColor,showPerformance=_b.showPerformance,_d=_b.offscreenDraw,offscreenDraw=void 0===_d||_d,frameCallback=_b.frameCallback,_e=_b.suspendOnBlur,suspendOnBlur=void 0===_e||_e,_this=_super.call(this,{canvas:canvas,fullscreen:!1,backgroundColor:backgroundColor,showPerformance:showPerformance,superSampling:superSampling,suspendOnBlur:suspendOnBlur})||this;if(_this.preRendering=!1,_this.drawing=!1,_this.callbackCount=0,_this.width=_this.canvas.width,_this.height=_this.canvas.height,fullscreen){_this.canvas.setAttribute("style",_this.canvas.getAttribute("style")+";position: fixed; width: 100%; height: 100%;");var renderer_2=_this;window.addEventListener("resize",(function(){renderer_2.resize()})),_this.resize()}var p=_this;if(offscreenDraw&&_this.canvas.transferControlToOffscreen?_this.renderWorker=new RenderWorker(_this.canvas,(function(){p.renderCallback()}),(function(){p.renderSync()}),showPerformance):_this.ctx=_this.canvas.getContext("2d"),_this.sortingWorker=new SortingWorker((function(data){p.sortCallback(data)}),showPerformance),_this.lightingWorker=new LightingWorker((function(data){p.lightCallback(data)}),showPerformance),_this.projectingWorker=new ProjectingWorker((function(data){p.projectCallback(data)}),showPerformance),_this.frameCallback=frameCallback,suspendOnBlur){var renderer_3=_this;window.addEventListener("focus",(function(){setTimeout((function(){console.log("resuming..."),renderer_3.requestPreRender()}),0)}))}return _this}return __extends(PerformanceRenderer,_super),PerformanceRenderer.prototype.sortCallback=function(data){this.sortCache=data,this.callbackCheck()},PerformanceRenderer.prototype.lightCallback=function(data){this.lightCache=data,this.callbackCheck()},PerformanceRenderer.prototype.projectCallback=function(data){this.projectCache=data,this.callbackCheck()},PerformanceRenderer.prototype.renderSync=function(){this.preRendering||setTimeout((function(renderer){if(renderer.scene&&renderer.camera){var instance=Renderer.getCameraInstance(renderer.scene,renderer.camera);renderer.requestPreRender(instance)}}),0,this)},PerformanceRenderer.prototype.renderCallback=function(){if(this.drawing=!1,this.lastFrameTime){var frameTime,fps=1e3/(performance.now()-this.lastFrameTime);this.stats.setStat("FPS",fps,.1,0)}this.lastFrameTime=performance.now(),this.frameCallback&&setTimeout(this.frameCallback,0)},PerformanceRenderer.prototype.callbackCheck=function(){this.callbackCount++,3==this.callbackCount&&(this.preRendering=!1,this.callbackCount=0,setTimeout((function(renderer,s,p,l){var data=renderer.buildDrawData(s,p,l);setTimeout((function(){renderer.draw(data)}),0)}),0,this,this.sortCache,this.projectCache,this.lightCache))},PerformanceRenderer.prototype.render=function(scene,camera){if(!this.stats.suspended){var instance=Renderer.getCameraInstance(scene,camera);this.requestPreRender(instance)}},PerformanceRenderer.prototype.start=function(scene,camera){this.scene=scene,this.camera=camera;var instance=Renderer.getCameraInstance(scene,camera);this.requestPreRender(instance)},PerformanceRenderer.prototype.stop=function(){this.scene=void 0,this.camera=void 0},PerformanceRenderer.prototype.requestPreRender=function(instance){void 0===instance&&(instance=this.instanceQueue),this.preRendering||!instance||this.stats.suspended?this.instanceQueue=instance:(this.preRendering=!0,this.sortingWorker.assign(instance.fragments),this.lightingWorker.assign(instance),this.projectingWorker.assign({instance:instance,width:this.width,height:this.height}))},PerformanceRenderer.prototype.resize=function(width,height){void 0===width&&(width=window.innerWidth),void 0===height&&(height=window.innerHeight),this.width=width*this.superSampling,this.height=height*this.superSampling,this.renderWorker?this.renderWorker.resize(this.width,this.height):(this.canvas.width=this.width,this.canvas.height=this.height),this.lastDraw&&!this.drawing&&this.draw(this.lastDraw)},PerformanceRenderer.prototype.project=function(v,camera,superSamplePosition){void 0===superSamplePosition&&(superSamplePosition=!1);var w=this.width/(superSamplePosition?1:this.superSampling),h=this.height/(superSamplePosition?1:this.superSampling),worldPos=camera.getWorldTransform();return Renderer.project(v.sub(worldPos.position).quaternionRotate(worldPos.orientation.conjugate()),camera.fov,w,h)},PerformanceRenderer.prototype.draw=function(data){this.drawing=!0,this.renderWorker?this.renderWorker.assign(data):(this.renderSync(),this.stats.startTimer(),Renderer.draw(data,this.ctx),this.stats.setStat("Draw Time",this.stats.readTimer(),.1,3),this.renderCallback())},PerformanceRenderer.prototype.buildDrawData=function(s,p,l){this.stats.startTimer();var buffer=new ArrayBuffer(4*(Renderer.DRAW_HEADER_SIZE+Renderer.DRAW_FRAG_SIZE*s.length)),headerView=new Float32Array(buffer,0,Renderer.DRAW_HEADER_SIZE),color=Color.toRGB(this.backgroundColor);headerView[0]=color.r,headerView[1]=color.g,headerView[2]=color.b,headerView[3]=color.a,headerView[4]=this.width,headerView[5]=this.height;for(var i=0;i<s.length;i++)for(var fragView=new Float32Array(buffer,4*(Renderer.DRAW_HEADER_SIZE+i*Renderer.DRAW_FRAG_SIZE),Renderer.DRAW_FRAG_SIZE),p_i=s[i]*ProjectingWorker.DATA_SIZE,l_i=s[i]*LightingWorker.DATA_SIZE,fragData=[p[p_i+0],p[p_i+1],p[p_i+2],p[p_i+3],p[p_i+4],p[p_i+5],l[l_i+0],l[l_i+1],l[l_i+2],l[l_i+3],l[l_i+4],l[l_i+5],l[l_i+6],l[l_i+7]],n=0;n<fragView.length;n++)fragView[n]=fragData[n];return this.stats.setStat("Building Draw Data",this.stats.readTimer(),.1,3),buffer},PerformanceRenderer}(Renderer),PointLight=function(_super){function PointLight(_a){var _b=void 0===_a?{}:_a,_c=_b.radius,radius=void 0===_c?10:_c,_d=_b.position,position=void 0===_d?new Vector:_d,_e=_b.brightness,brightness=void 0===_e?1:_e,_f=_b.color,color=void 0===_f?new Color("WHITE"):_f,superCopy=_b.superCopy,state=_b.state,group=_b.group,_this=_super.call(this,{position:position,type:Urbject.POINT_LIGHT,superCopy:superCopy,state:state,group:group})||this;return _this.radius=radius,_this.brightness=brightness,_this.color=color,_this}return __extends(PointLight,_super),PointLight.prototype.getInstance=function(camera){if(!this.instanceCache){var instance=_super.prototype.getInstance.call(this,camera);return instance.lights.addFirst(this.copy({shallow:!0})),instance}return _super.prototype.getInstance.call(this,camera)},PointLight.prototype.intensityOn=function(t){var diff=Vector.sub(t.getCenter(),this.position),diffMag=Vector.quaternionRotate(diff,Quaternion.conjugate(this.orientation)).div(this.scaleVector).mag(),falloff=0==this.radius?0:Num.constrain((this.radius-diffMag)/this.radius,0,1),norm=t.getNormal();return falloff*Num.constrain((diff.angleBetween(norm)-Math.PI/2)/(Math.PI/2),0,1)*this.brightness},PointLight.prototype.copy=function(options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new PointLight({superCopy:_super.prototype.copy.call(this,options),color:this.color.copy(),brightness:this.brightness,radius:this.radius})},PointLight.getInstance=function(l,camera){return l.getInstance(camera)},PointLight.intensityOn=function(l,t){return l.intensityOn(t)},PointLight.copy=function(l,options){var superCopy,copy;return void 0===options&&(options={shallow:!1}),new PointLight({superCopy:Urbject.copy(l,{typeCheck:!1,shallow:options.shallow}),color:Color.copy(l.color),brightness:l.brightness,radius:l.radius})},PointLight}(Urbject),FocalPointController=function(_super){function FocalPointController(_a){var _b=void 0===_a?{}:_a,_c=_b.sensitivity,sensitivity=void 0===_c?1:_c,_d=_b.friction,friction=void 0===_d?.9:_d,_e=_b.zoomMultiplier,zoomMultiplier=void 0===_e?1:_e,_f=_b.focalPoint,focalPoint=void 0===_f?new Vector:_f,_g=_b.minDist,minDist=void 0===_g?1:_g,_h=_b.maxDist,maxDist=void 0===_h?20:_h,_j=_b.controlFace,controlFace=void 0===_j?window:_j,_this=_super.call(this,Controller.FOCAL_POINT)||this;_this.velocity=new Vector,_this.dMouse=new Vector,_this.sensitivity=sensitivity,_this.friction=Num.constrain(friction,0,1),_this.zoomMultiplier=zoomMultiplier,_this.focalPoint=focalPoint,_this.minDist=minDist,_this.maxDist=maxDist,_this.controlFace=controlFace,_this.timer=new Stats;var controller=_this;return controlFace.addEventListener("mousedown",(function(e){controller.mouseDown(e)})),controlFace.addEventListener("mouseup",(function(e){controller.mouseUp(e)})),controlFace.addEventListener("mousemove",(function(e){controller.mouseMove(e)})),controlFace.addEventListener("wheel",(function(e){controller.wheel(e)})),_this}return __extends(FocalPointController,_super),FocalPointController.prototype.move=function(camera){var t=this.timer.readTimer()/1e3;this.dMouse.mag()&&(this.velocity=this.dMouse.div(t).mult(this.sensitivity),this.dMouse=new Vector);var pos=Vector.sub(camera.position,this.focalPoint);void 0===this.dist&&(this.dist=pos.mag());var XYAxis=new Vector(pos.x,pos.y,0).normalize().rotateZ(Math.PI/2);camera.position.rotateAxis(XYAxis,-this.velocity.y*t/360),1!=Num.getSign(camera.position.x*pos.x)&&(camera.position.x=pos.x),1!=Num.getSign(camera.position.y*pos.y)&&(camera.position.y=pos.y),camera.position.rotateZ(-this.velocity.x*t/360),camera.position.normalize().mult(this.dist).add(this.focalPoint);var diff=Vector.sub(this.focalPoint,camera.position),diffXY=new Vector(diff.x,diff.y,0),diffZ=new Vector(diffXY.mag(),0,diff.z);camera.orientation=Quaternion.fromVector(diffZ).rotateZ(diffXY.angleBetween(Vector.axis(Vector.X_AXIS))*(diffXY.y>0?1:-1)),this.velocity.mult(Math.pow(1-this.friction,t)),this.timer.startTimer()},FocalPointController.prototype.mouseDown=function(e){this.mousePressed=!0},FocalPointController.prototype.mouseUp=function(e){this.mousePressed=!1},FocalPointController.prototype.mouseMove=function(e){this.mousePressed&&(this.dMouse.x+=e.movementX,this.dMouse.y+=e.movementY)},FocalPointController.prototype.wheel=function(e){if(e.deltaY){var zoomDir=Num.getSign(e.deltaY);this.dist=Num.constrain(this.dist+zoomDir*this.zoomMultiplier,this.minDist||.001,this.maxDist)}},FocalPointController}(Controller);if("undefined"==typeof window)switch(self.name){case""+UrchinWorker.RENDER:var workerCanvas_1,workerCtx_1,buffer=void 0;self.addEventListener("message",(function(evt){return void 0!==evt.data.canvas?(console.log("Initializing Urchin Render Worker..."),workerCanvas_1=evt.data.canvas,void(workerCtx_1=workerCanvas_1.getContext("2d"))):void 0!==evt.data.dimensions?(workerCanvas_1.width=evt.data.dimensions.width,void(workerCanvas_1.height=evt.data.dimensions.height)):void 0!==evt.data.buffer?(Renderer.draw(evt.data.buffer,workerCtx_1),void self.postMessage({},void 0)):void 0}));break;case""+UrchinWorker.SORTING:self.addEventListener("message",(function(evt){for(var buffer=evt.data.buffer,extremes=evt.data.extremes,minGroup=evt.data.minGroup,maxGroup=evt.data.maxGroup,view=new Float32Array(buffer),count=view.length/SortingWorker.FRAG_SIZE,groups=new Array,i=0;i<count;i++){var frag_i=i*SortingWorker.FRAG_SIZE,group=view[frag_i+2],diff=extremes[group].max-extremes[group].min,bucketNum=diff?Math.floor((count-1)*Num.constrain(1-(view[frag_i+1]-extremes[group].min)/diff,0,1)):0,fragBuckets;groups[group]||(groups[group]=new Array),(fragBuckets=groups[group])[bucketNum]||(fragBuckets[bucketNum]=new List),fragBuckets[bucketNum].addByPriority(view[frag_i],view[frag_i+1])}for(var sortedBuffer=new ArrayBuffer(4*count),sortedView=new Float32Array(sortedBuffer),num=0,i=minGroup;i<=maxGroup;i++)if(groups[i])for(var fragBuckets=groups[i],b=0;b<fragBuckets.length;b++)if(fragBuckets[b])for(var current=fragBuckets[b].head;current;)sortedView[num]=current.data,num++,current=current.nxt;self.postMessage({buffer:sortedBuffer},void 0,[sortedBuffer])}));break;case""+UrchinWorker.LIGHTING:self.addEventListener("message",(function(evt){for(var buffer=evt.data.buffer,lightObj=evt.data.lights,lights=new List,current=lightObj.head;current;){var light=Urbject.copy(current.data,{shallow:!0,typeCheck:!0});lights.addFirst(light),current=current.nxt}for(var view=new Float32Array(buffer),litBuffer=new ArrayBuffer(4*view.length*LightingWorker.DATA_SIZE/LightingWorker.FRAG_SIZE),litView=new Float32Array(litBuffer),i=0;i<view.length/LightingWorker.FRAG_SIZE;i++){var frag_i=i*LightingWorker.FRAG_SIZE,data_i=i*LightingWorker.DATA_SIZE,f_r=view[frag_i+9],f_g=view[frag_i+10],f_b=view[frag_i+11],f_a=view[frag_i+12],w_r=view[frag_i+13],w_g=view[frag_i+14],w_b=view[frag_i+15],w_a=view[frag_i+16],lit=view[frag_i+17]>0;if(lit)for(var v0=new Vector(view[frag_i+0],view[frag_i+1],view[frag_i+2]),v1=new Vector(view[frag_i+3],view[frag_i+4],view[frag_i+5]),v2=new Vector(view[frag_i+6],view[frag_i+7],view[frag_i+8]),t=new Trigon(v0,v1,v2),mat=new Material({fill:new Color(f_r,f_g,f_b,f_a),wire:new Color(w_r,w_g,w_b,w_a),lit:lit}),frag=new Fragment(t,mat,0),litMat=Renderer.light(frag,lights),fragData=[litMat.fill.r,litMat.fill.g,litMat.fill.b,litMat.fill.a,litMat.wire.r,litMat.wire.g,litMat.wire.b,litMat.wire.a],n=0;n<LightingWorker.DATA_SIZE;n++)litView[data_i+n]=fragData[n];else for(var n=0;n<LightingWorker.DATA_SIZE;n++)litView[data_i+n]=view[frag_i+9+n]}self.postMessage({buffer:litBuffer},void 0,[litBuffer])}));break;case""+UrchinWorker.PROJECTING:self.addEventListener("message",(function(evt){for(var buffer=evt.data.buffer,camera=Camera.copy(evt.data.camera),width=evt.data.width,height=evt.data.height,view=new Float32Array(buffer),projected=new ArrayBuffer(4*view.length*2/3),projectedView=new Float32Array(projected),i=0;i<view.length/3;i++){var v=new Vector(view[3*i],view[3*i+1],view[3*i+2]).add(Vector.neg(camera.position));v.quaternionRotate(Quaternion.conjugate(camera.orientation));var screenPos=Renderer.project(v,camera.fov,width,height);projectedView[2*i]=screenPos.x,projectedView[2*i+1]=screenPos.y}self.postMessage({buffer:projected},void 0,[projected])}));break;default:console.error('Worker type, "'+self.name+'", is not a valid type.')}